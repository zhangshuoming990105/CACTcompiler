[TOC]

# 编译原理研讨课实验PR001实验报告

## 任务说明

1. 从源代码编译安装ANTLR和ANTLR CPP Runtime。
2. 编写文法文件并生成lexer和parser。
   - 根据CACT文法规范，编写.g4文件，并通过ANTLR生成lexer和parser，对输入的CACT语言源代码（.cact文件）进行词法和语法分析。
   - 修改ANTLR中默认的文法错误处理机制，使其能正确处理词法和语法错误。

## 成员组成

- 杨程远 2017K8009929032
- 张朔铭 2017K8009929050

## 实验设计

### 设计思路

利用antlr4生成合乎CACT语法标准的词法和语法语法分析器。
针对之后语义分析遍历语法树的需要，对文法略作改动，同时通过antlr4的 #标签 来生成遍历语法树时更利于分析的结点。

### 实验实现
- 利用antlr4的grun -gui功能，可以生成可读性非常强的`AST`图片，方便检查词法分析与语法分析阶段是否有问题。目前发现的是只有生成java版本词法与语法分析器的可以这么测试。
- 根据`AST`的数据结构，了解了antlr4生成的树结点的组织结构与数据访问方式。学习了上下文`ctx`的使用方法，这对于之后进行语义分析和中间代码生成非常关键。
- 设计过程中添加了不少自己的sample进行测试，目前仅就lex_syntax阶段对这些sample可以进行正确的分析，其中就发现了此前所写g4文件中的一个奇异bug。
  - 此前的文法对于表达式exp，无法对带'-'符号的表达式进行正确的语法分析，生成的语法分析树不正确，而对于'+','*','/','%'却没有这样的问题。
  - 后面测试改代码，过了很久才发现，是将'-'打成了中文全角的'－'，在编辑器中很难看出来，很是让人疑惑，最后是仔细检查发现不可能是别的问题了，再回看g4文法锁定在'-'附近时才找到的问题。

    

### 其它
- 第二阶段设计符号表时参考了 https://github.com/Alex-Beng/qcc 中符号表的实现，这里仅参考数据结构的设计。

## 总结

### 实验结果总结

ANTLR是一个强大的工具，它在自动实现词法、语法分析的同时也给了用户充分的自由，能够利用其提供的API实现定制的功能。本次实验让我们体会到了选择一个合适的工具能够极大地提高工作的效率。

### 分成员总结

#### 杨程远

本次实验中，我设计、修改了工程的框架，编写Makefile，以及进行git的管理。
在此过程中，我花了大量时间学习、熟悉Makefile和git的使用，但花费这些时间也让项目更易管理，达到磨刀不误砍柴工的目的。

关于项目框架，我做了以下设计：

- 为了方便文件依赖关系的管理，采用Makefile而不是初始的sh脚本，由`make all`生成分析器程序，build.sh中运行`make all`并将生成的程序复制到根目录，命名成main。

- ANTLR的输出放在./grammar/generated中，不与.g4文件放在同一个文件夹中。该generated文件夹被git忽略，`make clean`时清除。
- 生成的parser程序放在build文件夹中，git忽略，`make clean`时清除。
- 将demogrammar中的samples文件夹原样放在本项目中。

#### 张朔铭

本次实验第一阶段中，我主要学习使用antlr4的功能，根据实验提供的CACT语言手册，建立了与之对应的g4文件，生成了对应的自动生成的词法分析器lexer和语法分析器parser。

在完成词法分析和语法分析后，已经可以解决对samples中lex_and_syntax部分的分析，可以生成正确的AST

利用antlr4提供的listener模式，可以对AST进行访问，做语义检查，符号表维护和中间代码生成的步骤。在阶段一的实验中，我已经尝试进行这些工作，依照这样的代码框架，目前的代码布局如下：
- main.cpp 主流程函数所在的文件，主流程是：
    - 通过istream 读入cact文件的字符流
    - 通过生成的lexer读入字符流，输出由文法符号组成的`tokenstream`
    - 通过生成的parser读入`tokenstream`，生成`AST`
       - 如果lexer和parser阶段没有发现错误，则输入文件是符合CACT词法和语法的，也就是可以完成CACT实验第一阶段的测试。
      - 如果在这一阶段有错，则antlr4的词法分析与语法分析器会自动将错误指出，但同时也会尝试生成相应的`AST`,这里根据实验一的要求，如果有错，则会`return 1`；结束编译过程并报错。
    - 实例化listener，并尝试通过walk方法从文法的根节点去分析`AST`，完成语义检查，符号表的维护与使用，以及进行中间代码生成
      - 目前符号表和中间代码生成的部分还未完成，正在跟进理论课进度进行实现，PR001提交阶段放的是此前保存的稳定版本
      - walk过程中遇到语义错误，同样会结束编译过程并报错。
    - 在主函数运行过程中，还加入了编译用时的统计，方便之后帮助进行优化。

- symbolTable.h
  - 符号表的定义，符号表相关查询，添加操作的声明。
- symbolTable.cpp
  - 符号表查询，添加，debug打印 等操作函数的具体实现，目前已经完成一部分，但设计尚未完善，可能还会有修改。
- IRListener.cpp
  - 对于`AST`访问时，根据文法规律和组织结构，进行变量声明定义，表达式求值，函数声明和调用等过程的处理，同时还进行语义的检查。此部分应是PR002阶段的重点。
- IR
  - 中间代码相关的设计，目前尚未完成。
